generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}


// Normal schema change (dev)     npx prisma migrate dev
// First time DB setup npx prisma migrate dev
// Just edited Prisma Client usage npx prisma generate


enum Role {
  STUDENT
  TEACHER
  ADMIN
  SUPER_ADMIN
}

/* =======================
   INSTITUTION
======================= */

model Institution {
  id        String   @id @default(uuid())
  name      String
  type      String   // SCHOOL | COLLEGE
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  classes   Class[]
  inventory Inventory[]

  @@index([type])
}

/* =======================
   USER
======================= */

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  phone         String?
  provider      String?  // Google | Credential
  password      String
  role          Role

  institutionId String?
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)

  studentProfile StudentProfile?
  teacherProfile TeacherProfile?

  version   Int      @default(1) // optimistic lock when use multiple instances of the app
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([institutionId])
  @@index([role])
}

/* =======================
   STUDENT
======================= */

model StudentProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  rollNo    String
  guardian  String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  fees        Fee[]
  results     Result[]
  attendance  Attendance[]
  issuedItems IssuedItem[]

  version Int @default(1) // optimistic lock when use multiple instances of the app
}

/* =======================
   TEACHER
======================= */

model TeacherProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  salary         Float
  isClassTeacher Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments TeacherAssignment[]
  attendance  Attendance[]
  documents   Document[]
  salaries    SalaryHistory[]

  version Int @default(1)
}

/* =======================
   ACADEMIC STRUCTURE
======================= */

model Class {
  id            String @id @default(uuid())
  name          String
  institutionId String

  institution Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  sections    Section[]

  @@unique([name, institutionId]) // Class names unique per institution
  @@index([institutionId])
}

model Section {
  id      String @id @default(uuid())
  name    String
  classId String

  class        Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  enrollments  Enrollment[]
  assignments  TeacherAssignment[]

  @@unique([name, classId]) // Section names unique per class
  @@index([classId])
}

model Subject {
  id   String @id @default(uuid())
  name String @unique

  teacherAssignments TeacherAssignment[]
  results            Result[]
}

/* =======================
   RELATIONS
======================= */

model Enrollment {
  id        String   @id @default(uuid())
  studentId String
  sectionId String
  createdAt DateTime @default(now())

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  section Section        @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([studentId, sectionId]) // Prevent duplicate enrollments
  @@index([studentId])
  @@index([sectionId])
}

model TeacherAssignment {
  id        String   @id @default(uuid())
  teacherId String
  sectionId String
  subjectId String
  createdAt DateTime @default(now())

  teacher TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  section Section        @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subject Subject        @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@unique([teacherId, sectionId, subjectId]) // Prevent duplicate assignments
  @@index([teacherId])
  @@index([sectionId])
  @@index([subjectId])
}

/* =======================
   ATTENDANCE
======================= */

model Attendance {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  status    String   // PRESENT | ABSENT | LATE

  studentId String?
  teacherId String?

  student StudentProfile? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacher TeacherProfile? @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([studentId, date]) // One attendance record per student per day
  @@unique([teacherId, date]) // One attendance record per teacher per day
  @@index([date])
  @@index([studentId])
  @@index([teacherId])
}

/* =======================
   FEES & RESULTS
======================= */

model Fee {
  id        String   @id @default(uuid())
  amount    Float
  status    String   // PAID | PENDING | OVERDUE
  dueDate   DateTime
  paidAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([status])
  @@index([dueDate])
}

model Result {
  id        String   @id @default(uuid())
  grade     String
  marks     Float
  examType  String?  // MIDTERM | FINAL | QUIZ
  createdAt DateTime @default(now())

  studentId String
  subjectId String

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject Subject        @relation(fields: [subjectId], references: [id], onDelete: Restrict)

  @@index([studentId])
  @@index([subjectId])
}

/* =======================
   INVENTORY
======================= */

model Inventory {
  id            String   @id @default(uuid())
  name          String
  quantity      Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  @@index([institutionId])
}

model IssuedItem {
  id         String    @id @default(uuid())
  itemName   String
  issuedAt   DateTime  @default(now())
  returnedAt DateTime?

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
}

/* =======================
   DOCUMENTS & SALARY
======================= */

model Document {
  id        String   @id @default(uuid())
  title     String
  fileUrl   String
  createdAt DateTime @default(now())

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
}

model SalaryHistory {
  id        String   @id @default(uuid())
  amount    Float
  paidAt    DateTime
  month     Int      // 1-12
  year      Int

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, month, year]) // Prevent duplicate salary entries
  @@index([teacherId])
}